#!/bin/sh

# Pre-commit hook for code quality checks
# Runs inside Docker container - compatible with Windows, Linux, and macOS
# Requires: Docker and docker-compose

echo ""
echo "=== Running code quality checks ==="
echo ""

# Run PHP CS Fixer
echo "[1/2] Checking code style (PHP CS Fixer)..."
docker compose exec -T hyperf-pix vendor/bin/php-cs-fixer fix --dry-run --diff --config=.php-cs-fixer.php
CS_FIXER_EXIT=$?

if [ $CS_FIXER_EXIT -ne 0 ]; then
    echo ""
    echo "[ERROR] Code style issues found!"
    echo "[!] Run 'make cs-fix' to fix them automatically"
    echo ""
    FAILED=1
else
    echo "[OK] Code style OK"
    echo ""
fi

# Run PHPStan
echo "[2/2] Running static analysis (PHPStan level 5)..."
docker compose exec -T hyperf-pix vendor/bin/phpstan analyse --memory-limit=200M
PHPSTAN_EXIT=$?

if [ $PHPSTAN_EXIT -ne 0 ]; then
    echo ""
    echo "[ERROR] PHPStan found errors!"
    echo "[!] Fix the errors or adjust phpstan.neon.dist"
    echo ""
    FAILED=1
else
    echo "[OK] PHPStan OK"
    echo ""
fi

# Result
if [ ! -z "$FAILED" ]; then
    echo "================================="
    echo "[ERROR] Pre-commit checks FAILED!"
    echo "[!] Fix the issues above before committing."
    echo "================================="
    echo ""
    exit 1
fi

echo "================================="
echo "[OK] All checks passed!"
echo "================================="
echo ""
exit 0
